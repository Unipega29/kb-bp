<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Инструменты для распределения средств</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS 1p', sans-serif;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        colgroup col:nth-child(2) {
            width: 60%;
        }
        th, td {
            text-align: center;
            padding: 8px;
            border: 1px solid white;
        }
        th {
            background-color: mediumaquamarine;
        }
        td {
            background-color: #bfefdf;
        }
        .number-col {
            background-color: mediumaquamarine;
        }
        #totalAmount, button {
            font-size: 1em;
            padding: 5px;
            margin-top: 10px;
        }
        .clear-btn {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Инструменты для распределения средств</h1>

    <label for="totalAmount">Общие средства:</label>
    <input type="number" id="totalAmount" required>
    <button onclick="calculateBetting()">Рассчитать</button>
    <button onclick="pasteOdds()">Вставить</button>

    <table>
        <colgroup>
            <col>
            <col>
            <col>
            <col>
        </colgroup>
        <thead>
            <tr>
                <th>Номер</th>
                <th>Увел.</th>
                <th>Колья</th>
                <th>Возврат</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- データ行を動的に生成 -->
        </tbody>
    </table>

    <button class="clear-btn" onclick="clearTable()">Очистить</button>

    <script>
        const maxHorses = 18; // 18頭に戻す
        const tableBody = document.getElementById('tableBody');
        const distributionPercentages = [29.34, 21.03, 14.35, 11.83, 8.33, 5.63, 4.59, 3.31, 1.59]; // 分割割合（9頭分）

        // テーブル行を生成
        for (let i = 1; i <= maxHorses; i++) {
            const row = document.createElement('tr');

            const numberCell = document.createElement('td');
            numberCell.textContent = i;
            numberCell.classList.add('number-col');

            const oddsCell = document.createElement('td');
            const oddsInput = document.createElement('input');
            oddsInput.type = 'number';
            oddsInput.step = '0.1';
            oddsInput.id = `odds${i}`;
            oddsInput.onblur = () => validateOdds(oddsInput);
            oddsCell.appendChild(oddsInput);

            const betCell = document.createElement('td');
            betCell.id = `bet${i}`;
            betCell.textContent = "-";

            const payoutCell = document.createElement('td');
            payoutCell.id = `payout${i}`;
            payoutCell.textContent = "-";

            row.appendChild(numberCell);
            row.appendChild(oddsCell);
            row.appendChild(betCell);
            row.appendChild(payoutCell);
            tableBody.appendChild(row);
        }

        function validateOdds(input) {
            const oddsValue = parseFloat(input.value);
            if (!isNaN(oddsValue) && oddsValue < 4) {
                alert("Введите минимум 4 !!!");
                input.value = '';
            }
        }

        async function pasteOdds() {
            try {
                const text = await navigator.clipboard.readText();
                const oddsArray = text.split(/\s+/).map(Number).filter(num => !isNaN(num));

                for (let i = 0; i < maxHorses && i < oddsArray.length; i++) {
                    document.getElementById(`odds${i + 1}`).value = oddsArray[i];
                }
            } catch (err) {
                alert("クリップボードの内容を読み込めませんでした。");
            }
        }

        function calculateBetting() {
            const totalAmount = parseFloat(document.getElementById("totalAmount").value);

            if (isNaN(totalAmount)) {
                alert("Введите общие средства");
                return;
            }

            let oddsList = [];
            for (let i = 1; i <= maxHorses; i++) {
                const oddsValue = parseFloat(document.getElementById(`odds${i}`).value);
                if (!isNaN(oddsValue) && oddsValue >= 4) {
                    oddsList.push({ horse: i, odds: oddsValue });
                }
            }

            // 最低賭け金額を計算し、資金を分配
            let remainingAmount = totalAmount;

            // 各オッズの最低賭け金額を計算
            oddsList.forEach(entry => {
                const targetPayout = totalAmount * 1.1;
                const minimumBetAmount = Math.max(100, Math.ceil(targetPayout / entry.odds / 100) * 100);
                const payoutAmount = Math.floor(minimumBetAmount * entry.odds);

                document.getElementById(`bet${entry.horse}`).textContent = minimumBetAmount.toLocaleString();
                document.getElementById(`payout${entry.horse}`).textContent = payoutAmount.toLocaleString();

                remainingAmount -= minimumBetAmount;
            });

            // 残りの資金を指定された割合で分配
            let remainingPercentage = [...distributionPercentages];
            let remainingSum = remainingAmount;
            let count = 0;

            for (let i = 0; i < oddsList.length && count < distributionPercentages.length; i++) {
                const entry = oddsList[i];
                if (entry.odds >= 4) {
                    const additionalAmount = (remainingSum * remainingPercentage[count]) / 100;
                    const updatedBetAmount = parseFloat(document.getElementById(`bet${entry.horse}`).textContent.replace(/,/g, '')) + Math.ceil(additionalAmount);
                    document.getElementById(`bet${entry.horse}`).textContent = updatedBetAmount.toLocaleString();

                    const updatedPayoutAmount = Math.floor(updatedBetAmount * entry.odds);
                    document.getElementById(`payout${entry.horse}`).textContent = updatedPayoutAmount.toLocaleString();

                    count++;
                }
            }
        }

        function clearTable() {
            for (let i = 1; i <= maxHorses; i++) {
                document.getElementById(`odds${i}`).value = '';
                document.getElementById(`bet${i}`).textContent = "-";
                document.getElementById(`payout${i}`).textContent = "-";
            }
        }
    </script>
</body>
</html>
